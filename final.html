<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>苏州市智慧交通系统 (OSM精准版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://api.map.baidu.com/api?v=3.0&amp;ak=cQgiplWjsTZs6D38GtVxwwZGFClmPnSx"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#1E88E5', danger: '#D32F2F', dark: '#263238' }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(0,0,0,0.1); }

            /* 视频窗口样式 */
            #video-container {
                position: fixed;
                z-index: 50;
                background: #000;
                box-shadow: 0 20px 50px rgba(0,0,0,0.5);
                border-radius: 8px;
                overflow: hidden;
                resize: both; /* 允许缩放 */
            }
            /* 隐藏原生缩放手柄，用自定义的 */
            #video-container::-webkit-resizer { background: transparent; }
            .resize-handle {
                position: absolute; bottom: 0; right: 0; width: 20px; height: 20px;
                background: linear-gradient(135deg, transparent 50%, #D32F2F 50%);
                cursor: se-resize; pointer-events: none; z-index: 60;
            }

            .map-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
            .overlay { position: absolute; z-index: 20; }
        }
    </style>
</head>
<body class="font-sans text-dark overflow-hidden h-screen w-screen bg-gray-200">

<div id="map" class="map-container"></div>

<div class="overlay top-0 w-full py-3 bg-white/90 shadow flex justify-center pointer-events-none">
    <h1 class="text-2xl font-bold flex items-center pointer-events-auto">
        <i class="fa fa-road text-primary mr-3"></i>
        苏州市智慧交通系统 <span class="text-xs bg-primary text-white px-2 py-0.5 rounded ml-2">OSM Data</span>
    </h1>
</div>

<div class="overlay left-4 top-20 glass w-80 p-5 rounded-xl shadow-xl hover:scale-[1.01] transition">
    <h2 class="text-lg font-bold mb-3 border-b pb-2 text-primary">
        <i class="fa fa-globe"></i> 道路精准标红
    </h2>
    <div class="space-y-3">
        <input type="text" id="road-name" placeholder="输入路名 (如: 干将路)"
               class="w-full px-3 py-2 rounded border border-gray-300 focus:ring-2 focus:ring-primary outline-none">

        <button id="search-road-btn" class="w-full bg-primary hover:bg-blue-600 text-white font-bold py-2 rounded shadow transition flex justify-center items-center">
            <span>获取全路网形状</span>
        </button>

        <div id="road-status" class="text-xs text-gray-500 bg-gray-50 p-2 rounded min-h-[40px]">
            <i class="fa fa-info-circle"></i> 请确保网络能连接 Overpass API
        </div>
    </div>
</div>

<div class="overlay right-4 top-20 bottom-4 w-72 flex flex-col gap-3 pointer-events-none">
    <div class="glass p-3 rounded-xl shadow-lg pointer-events-auto h-56 flex flex-col">
        <h3 class="font-bold text-sm mb-2 text-gray-700">实时流量</h3>
        <div class="flex-1 relative"><canvas id="dateChart"></canvas></div>
    </div>
    <div class="glass p-3 rounded-xl shadow-lg pointer-events-auto flex-1 flex flex-col">
        <h3 class="font-bold text-sm mb-2 text-gray-700">监控列表</h3>
        <div id="markers-list" class="overflow-y-auto flex-1 text-xs space-y-2"></div>
    </div>
</div>

<div id="video-container" style="left: 20px; bottom: 20px; width: 320px; height: 220px;">
    <div id="video-header" class="bg-gray-900 text-white px-3 py-2 cursor-move flex justify-between items-center select-none">
        <span class="font-bold text-xs"><i class="fa fa-video-camera text-red-500 mr-2"></i>实时监控</span>
        <i class="fa fa-arrows text-gray-500"></i>
    </div>
    <div class="relative w-full h-full bg-black pb-8"> <video id="video1" autoplay muted loop playsinline class="w-full h-full object-cover">
        <source src="11.mp4" type="video/mp4">
    </video>
        <div class="resize-handle"></div>
    </div>
</div>

<script>
    let map;
    let currentOverlays = [];
    let dateChart = null;

    window.onload = function() {
        initMap();
        initCharts();
        initDraggableVideo();
        initEvents();
        loadRouteFromCSV();
    };

    function initMap() {
        map = new BMap.Map("map", {enableMapClick: false});
        // 苏州中心
        const center = new BMap.Point(120.619585, 31.299379);
        map.centerAndZoom(center, 13);
        map.enableScrollWheelZoom(true);
        map.setMapStyleV2({styleId: '3d96e57d1959828591f8936936319808'}); // 科技蓝风格
    }

    // ==========================================
    //  Overpass API 核心逻辑 (恢复使用)
    // ==========================================
    async function searchRoad() {
        const input = document.getElementById('road-name');
        const status = document.getElementById('road-status');
        const btn = document.getElementById('search-road-btn');
        const name = input.value.trim();

        if (!name) return;

        // UI 重置
        clearOverlays();
        status.innerHTML = '<span class="text-blue-600"><i class="fa fa-spinner fa-spin"></i> 连接 Overpass API...</span>';
        btn.disabled = true;
        btn.classList.add('opacity-50');

        // 1. 构建 Overpass 查询语句
        // 使用正则匹配，例如搜“干将路”，匹配“干将东路”、“干将西路”
        // 限制在苏州周边 (bbox: 30.7,119.8,32.2,121.5) 提高速度
        const query = `
                [out:json][timeout:25];
                (
                  way["name"~"${name}"](30.7,119.8,32.2,121.5);
                  relation["name"~"${name}"](30.7,119.8,32.2,121.5);
                );
                out geom;
            `;

        try {
            // 2. 发起请求 (需要 VPN)
            const response = await fetch('https://overpass-api.de/api/interpreter', {
                method: 'POST',
                body: 'data=' + encodeURIComponent(query)
            });

            if (!response.ok) throw new Error("API连接失败");

            const data = await response.json();

            // 3. 解析数据
            if (!data.elements || data.elements.length === 0) {
                status.innerHTML = '<span class="text-red-500">未找到相关数据，请尝试全名</span>';
                btn.disabled = false;
                btn.classList.remove('opacity-50');
                return;
            }

            status.innerHTML = `<span class="text-green-600">找到 ${data.elements.length} 个路段，正在渲染...</span>`;

            processOverpassData(data.elements);

            btn.disabled = false;
            btn.classList.remove('opacity-50');

        } catch (error) {
            console.error(error);
            status.innerHTML = '<span class="text-red-500">连接超时！请检查网络 (需VPN)</span>';

            // 失败后回退到百度简单定位，防止用户没事干
            fallbackToBaidu(name);

            btn.disabled = false;
            btn.classList.remove('opacity-50');
        }
    }

    function processOverpassData(elements) {
        let allPoints = [];
        let bounds = [];

        elements.forEach(el => {
            let path = [];

            // 处理 Way (路径)
            if (el.type === 'way' && el.geometry) {
                path = el.geometry.map(pt => wgs84ToBd09(pt.lon, pt.lat));
            }
            // 处理 Relation (关系，通常是大路)
            else if (el.type === 'relation' && el.members) {
                el.members.forEach(m => {
                    if (m.type === 'way' && m.geometry) {
                        const subPath = m.geometry.map(pt => wgs84ToBd09(pt.lon, pt.lat));
                        drawRedLine(subPath); // 立即绘制子路段
                        allPoints.push(...subPath);
                    }
                });
                return; // 关系已经处理完了，跳过下面的绘制
            }

            if (path.length > 0) {
                drawRedLine(path);
                allPoints.push(...path);
            }
        });

        // 调整视野
        if (allPoints.length > 0) {
            // 取样计算中心点，防止点太多计算慢
            const center = allPoints[Math.floor(allPoints.length / 2)];
            map.setViewport(allPoints);

            // 添加中心标记
            const marker = new BMap.Marker(center);
            map.addOverlay(marker);
            marker.setAnimation(BMAP_ANIMATION_BOUNCE);
            currentOverlays.push(marker);
        }
    }

    function drawRedLine(points) {
        // 绘制鲜艳的红色线条
        const line = new BMap.Polyline(points, {
            strokeColor: "#FF0000",
            strokeWeight: 6,
            strokeOpacity: 0.9,
            enableMassClear: true
        });
        map.addOverlay(line);
        currentOverlays.push(line);
    }

    function fallbackToBaidu(name) {
        // 如果 Overpass 失败，至少用百度定位一下
        const local = new BMap.LocalSearch(map, {
            onSearchComplete: (res) => {
                if (local.getStatus() === BMAP_STATUS_SUCCESS && res.getNumPois() > 0) {
                    const pt = res.getPoi(0).point;
                    map.centerAndZoom(pt, 15);
                    const mk = new BMap.Marker(pt);
                    map.addOverlay(mk);
                    currentOverlays.push(mk);
                    document.getElementById('road-status').innerHTML += '<br><span class="text-gray-500 text-xs">已切换至百度备用定位</span>';
                }
            }
        });
        local.search(name);
    }

    function clearOverlays() {
        currentOverlays.forEach(o => map.removeOverlay(o));
        currentOverlays = [];
    }

    // ==========================================
    //  坐标转换 (WGS84 -> BD09)
    //  Overpass返回的是GPS坐标，必须转成百度坐标才能对其
    // ==========================================
    const PI = 3.1415926535897932384626;
    const x_pi = 3.14159265358979324 * 3000.0 / 180.0;
    const a = 6378245.0;
    const ee = 0.00669342162296594323;

    function wgs84ToBd09(lng, lat) {
        const gcj = wgs84ToGcj02(lng, lat);
        return gcj02ToBd09(gcj[0], gcj[1]);
    }

    function wgs84ToGcj02(lng, lat) {
        let dLat = transformLat(lng - 105.0, lat - 35.0);
        let dLng = transformLon(lng - 105.0, lat - 35.0);
        const radLat = lat / 180.0 * PI;
        let magic = Math.sin(radLat);
        magic = 1 - ee * magic * magic;
        const sqrtMagic = Math.sqrt(magic);
        dLat = (dLat * 180.0) / ((a * (1 - ee)) / (magic * sqrtMagic) * PI);
        dLng = (dLng * 180.0) / (a / sqrtMagic * Math.cos(radLat) * PI);
        return [lng + dLng, lat + dLat];
    }

    function gcj02ToBd09(lng, lat) {
        const z = Math.sqrt(lng * lng + lat * lat) + 0.00002 * Math.sin(lat * x_pi);
        const theta = Math.atan2(lat, lng) + 0.000003 * Math.cos(lng * x_pi);
        const bdLng = z * Math.cos(theta) + 0.0065;
        const bdLat = z * Math.sin(theta) + 0.006;
        return new BMap.Point(bdLng, bdLat);
    }

    function transformLat(x, y) {
        let ret = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x));
        ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
        ret += (20.0 * Math.sin(y * PI) + 40.0 * Math.sin(y / 3.0 * PI)) * 2.0 / 3.0;
        ret += (160.0 * Math.sin(y / 12.0 * PI) + 320.0 * Math.sin(y * PI / 30.0)) * 2.0 / 3.0;
        return ret;
    }

    function transformLon(x, y) {
        let ret = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x));
        ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
        ret += (20.0 * Math.sin(x * PI) + 40.0 * Math.sin(x / 3.0 * PI)) * 2.0 / 3.0;
        ret += (150.0 * Math.sin(x / 12.0 * PI) + 300.0 * Math.sin(x / 30.0 * PI)) * 2.0 / 3.0;
        return ret;
    }

    // ==========================================
    //  视频窗口拖拽逻辑 (Fix)
    // ==========================================
    function initDraggableVideo() {
        const container = document.getElementById("video-container");
        const header = document.getElementById("video-header");
        let isDragging = false;
        let startX, startY, startLeft, startTop;

        header.addEventListener("mousedown", (e) => {
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            const style = window.getComputedStyle(container);
            startLeft = parseInt(style.left, 10);
            startTop = parseInt(style.top, 10);
        });

        document.addEventListener("mousemove", (e) => {
            if (!isDragging) return;
            e.preventDefault();
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            container.style.left = `${startLeft + dx}px`;
            container.style.top = `${startTop + dy}px`;
        });

        document.addEventListener("mouseup", () => isDragging = false);
    }

    // 杂项
    function initCharts() {
        const ctx = document.getElementById('dateChart').getContext('2d');
        dateChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['8:00', '10:00', '12:00', '14:00'],
                datasets: [{label:'流量',data:[10,20,15,30],borderColor:'#1E88E5',fill:true}]
            },
            options: {responsive:true,maintainAspectRatio:false}
        });
    }

    function initEvents() {
        document.getElementById('search-road-btn').addEventListener('click', searchRoad);
        document.getElementById('road-name').addEventListener('keydown', (e) => {
            if(e.key==='Enter') searchRoad();
        });
    }

    function loadRouteFromCSV() {
        fetch('routes.csv').then(r=>r.text()).then(txt => {
            const pts = [];
            txt.split('\n').slice(1).forEach(l=>{
                const [lat,lng]=l.split(',').map(Number);
                if(lat&&lng) pts.push(new BMap.Point(lng,lat));
            });
            if(pts.length) {
                map.addOverlay(new BMap.Polyline(pts, {strokeColor:'blue',strokeWeight:4,strokeStyle:'dashed'}));
            }
        });
    }
</script>
</body>
</html>